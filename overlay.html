<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>xdtip Overlay</title>
    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@800&display=swap');

        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background: transparent; /* Transparent for OBS */
            font-family: 'Inter', sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh;
        }

        #alert-box {
            text-align: center;
            opacity: 0; /* Hidden by default */
            transform: translateY(50px);
            transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #alert-box.show {
            opacity: 1;
            transform: translateY(0);
        }

        .alert-image {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 5px solid #ff3b3b;
            box-shadow: 0 0 30px rgba(255, 59, 59, 0.6);
            object-fit: cover;
            margin-bottom: 15px;
            animation: pulse 2s infinite;
        }

        .alert-text {
            font-size: 48px;
            color: white;
            text-shadow: 0 4px 10px rgba(0,0,0,0.8);
            margin: 0;
        }

        .highlight { color: #ff3b3b; }

        .message {
            font-size: 28px;
            color: #ddd;
            margin-top: 10px;
            text-shadow: 0 2px 5px rgba(0,0,0,0.8);
            max-width: 600px;
        }

        @keyframes pulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 59, 0.7); }
            70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(255, 59, 59, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 59, 59, 0); }
        }
    </style>
</head>
<body>

    <div id="alert-box">
        <img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExMjR4ZGV4ZGV4ZGV4ZGV4ZGV4ZGV4ZGV4ZGV4ZGV4ZCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/LdOyjZ7io5Msw/giphy.gif" class="alert-image">
        
        <h1 class="alert-text"><span id="sender" class="highlight">Someone</span> sent <span id="amount">100</span>!</h1>
        
        <p class="message" id="message-text">This is an amazing message!</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const socket = io(); 
        const queue = [];    
        let isPlaying = false;
        let availableVoices = [];

        // Load voices immediately so they are ready
        window.speechSynthesis.onvoiceschanged = () => {
            availableVoices = window.speechSynthesis.getVoices();
            console.log("Voices loaded:", availableVoices.length);
        };

        // 1. Join Room
        const token = window.location.pathname.split('/').pop();
        if(token) {
            console.log("Joining Overlay for token:", token);
            socket.emit('join-overlay', token);
        }

        // 2. Listen for Tips
        socket.on('new-tip', (data) => {
            console.log("New Tip Received:", data);
            queue.push(data);
            processQueue();
        });

        // 3. Process Queue
        function processQueue() {
            if (isPlaying || queue.length === 0) return;

            isPlaying = true;
            const data = queue.shift();
            showAlert(data);
        }

        // 4. Show Visuals & Play TTS
        function showAlert(data) {
            document.getElementById('sender').innerText = data.sender;
            document.getElementById('amount').innerText = data.amount;
            document.getElementById('message-text').innerText = data.message;

            const box = document.getElementById('alert-box');
            box.classList.add('show');

            // Speak: "Sender sent Amount. Message"
            speakText(`${data.sender} sent ${data.amount} tokens. ${data.message}`, () => {
                setTimeout(() => {
                    box.classList.remove('show'); 
                    setTimeout(() => {
                        isPlaying = false;
                        processQueue(); 
                    }, 1000); 
                }, 2000); 
            });
        }

        // --- TTS FUNCTION (HINDI / HINGLISH SUPPORT) ---
        function speakText(text, callback) {
            if (!window.speechSynthesis) {
                console.error("Browser does not support TTS");
                return callback();
            }

            // Cancel any currently playing audio
            window.speechSynthesis.cancel();

            const utterance = new SpeechSynthesisUtterance(text);
            const voices = window.speechSynthesis.getVoices();

            // üéØ NEW PRIORITY FOR HINGLISH:
            // 1. English (India) -> Best for "Kya haal hai bro"
            // 2. Hindi (India)   -> Backup
            // 3. Generic English -> Final Backup
            let targetVoice = voices.find(v => v.lang.includes('en-IN')) || 
                              voices.find(v => v.lang.includes('hi-IN')) || 
                              voices.find(v => v.lang.includes('en'));

            if (targetVoice) {
                console.log("üó£Ô∏è Speaking with:", targetVoice.name);
                utterance.voice = targetVoice;
                
                // Tweak these for better Hinglish flow
                utterance.rate = 1.0;  // Normal speed (0.9 was too slow for English voice)
                utterance.pitch = 1.0; // Normal pitch
            } else {
                console.log("‚ö†Ô∏è No specific voice found, using default.");
            }

            // Handle End
            utterance.onend = function() {
                callback();
            };

            // Handle Errors
            utterance.onerror = function(e) {
                console.error("TTS Error:", e);
                callback();
            };

            window.speechSynthesis.speak(utterance);
        }

            window.speechSynthesis.speak(utterance);
        }
    </script>
</body>
</html>

